# AHC030

## After Contest

- 1マス掘りの解法を確認
- 占いによるベイズ推定を実装する
- Writer解を理解、実装する
  - 処理理解
    - read_input
      - 標準入力を取得し、以下の値を保持する(Input)
        - n, m, eps: 標準入力
        - n2: n*n
        - ts2: 同じ図形がある可能性があるので、ソートして保持する(後から同じ図形を判定しやすい？)
        - total: 埋蔵量の合計を保持する
        - max_i, max_j: 各図形の(i, j)の最大値を保持する
        - ts: (i, j)の二次元配列をi + n+jの一次元配列にする
        - masks: 各図形のマスク(埋蔵がある位置がtrue)を保持する(一次元配列)
        - ps: 真の配置の位置を保持する
      - Inputの関数
        - get_count: 渡した配置の位置に対応する埋蔵量を算出する
        - get_positives: 渡した配置の位置に対応する埋蔵箇所を返す(masksの各図形のマスクを、渡した配置の位置に対応した形のマスクを返す)

## 考察

- 1マスのクエリは埋蔵量を確実に確認できる
- 2マス以上のクエリは正規分布でばらつきがある
- 油田の形は分かっているため、端っこが分かれば推定できる
  - 端っこを推定するには、推定しやすい方向を見るとよさそう
- 油田の面積は、全体の面積の1/2から1/5
- 油田の数は2～20で、油田の面積を数で分割して1つの油田の大きさが決まる
- N, M, eでコストを見た方がよさそう
- N^2で確実に解けるため、N^2より少ないコストで解けるかが重要

## ToDo

- 油田が全て見つかったら処理終了(Done)
- スコア計算 => tester.extが返してた(Done)
- ローカルシミュレーション(Done)
- 並列処理(Done)
- マップ全体の期待値を算出(Done)
- 期待値があるところのみを計測する(Done)
- 期待値が高いところから計測(Done)
- 探索の中で各油田の可能性がないパターンを除外する(Done)
- 探索の中で各油田を特定する方法を考える(Done)
- 期待値の低い方から探索する => v7で期待値の低い方からの探索をしたがすべてのケースで悪化(Done)
- 高速化
- 複数マスの採掘を検討する
- 期待値の更新方法を検討する(二分探索、ベイズ推定)
  - 0以外の時の期待値の更新方法
  - 0以外で存在確率を更新する(近くはパターンに沿った油田があるはず)(Done)
- 効率のよい採掘方法を検討する
  - あるマスの四方がすべて0なら、そのマスも0(探索回数が5回=>4回に効率化可能)(Won't fix)
  - 0を見つけることを優先する => 近くを探索すると見つかる可能性が高い => 期待値が高く採掘場所から離れた場所を採掘する
  - 油田のパターンを特定したら他のパターンをFalseにする(Done)
  - (i+j)%2==0のみ処理する(Won't fix)
- 高速化+モンテカルロで効率の良い探索を探す
- パターンが特定されたら、他のパターンの対象外とする(Done)
- コードレビューで気づいたこと
  - 油田がある位置の確認で、poly.posesを使うと効率化できそう(cnt==1の処理)(Done)
  - e_mapsの実際の確率は、(0, 0)からのずれと、確率を分けて持つとどうか
  - 存在確率0のupdateは何がダメなの？ => TLE.得点も変わらない(少し悪くなる？)
  - 次の採掘の場所の工夫ができないか(現状は、期待値最大+同じならランダム)
  - 埋蔵量がある場合の情報を使いたい(_mining)

## 解法の方針

- マップ全体の埋蔵量の期待値を算出し、期待値から探す箇所を決めていく(二分探索、ベイズ推定が使える？)
- 探索の中で、各油田を特定し、期待値を更新する

### ルールベース

- v0: サンプルコード(提出: 12,696,000,000, 評価: 9,831,000,000)
- v1: 油田が全て見つかったら処理終了(提出: 11,474,000,000, 評価: 8,730,000,000)
- v2: 油田がある可能性がある箇所のみ確認(提出: 11,391,000,000, 評価: 8,604,000,000)
- v3: 期待値が高いところから計測(提出: 10,858,000,000, 評価: 8,537,000,000)
- v4: 期待値の算出方法のバグを修正(各油田のあり得るパターン数の除算を追加)(提出: 10,853,000,000, 評価: 8,514,000,000)
- v5: 探索の中で各油田の可能性がないパターンを除外する(TLE4件)(提出: TLEのため計測なし, 評価: 5,742,000,000)
- v6: 高速化.v5のTLE4件解消.評価を50件から100件に変更(提出: 8,244,000,000, 評価: 6,044,500,000)
- v7: 各油田が特定できたら追加して、油田があると分かった場所のminingはしない(提出: 7,870,000,000, 評価: 5,415,500,000=>6,183,500,000)
- v8: 期待値の高い順の中で、ランダムにする.評価を100件から200件に変更(提出: 7,566,000,000, 評価: 5,966,000,000)
- v9: 処理ごとにソートして期待値の一番高いマスを探索する(提出: 5,579,000,000, 評価: 4,517,500,000)
- v10: 位置ごとの存在確率を算出して1の場合は採掘せず追加する(提出: 5,539,000,000, 評価: 4,430,500,000)
- v11: パターンが特定されたら、他のパターンの対象外とする(TLE2件)(提出: , 評価: 3,888,250,000)
- v12: found_dをパターンが特定された時、確率が1になったときも追加.高速化(提出時はshow_map削除)(提出: 4,833,000,000, 評価: 3,851,500,000)
  - 6000テストケース: 4,261,816,666
- v13: 0以外で存在確率を更新する(近くはパターンに沿った油田があるはず)(提出: 未, 評価: 4,586,500,000) => v12に戻す
- v14: ソートを期待値から存在確率に変更(提出: 4,785,000,000, 評価: 3,839,250,000)
  - 6000テストケース: 4,260,250,000
- v15: ベイズを取り入れ、エラーがあったらv14で再処理(提出: , 評価: 4,985,000,000) => v14に戻す
- v16: sort時に0を除外(提出: 4,824,000,000, 評価: 3,850,750,000)
  - 6000テストケース: 4,261,633,333
- v17: optunaでパラメータチューニング(提出: 4,858,000,000, 評価: 3,829,500,000)
  - 6000テストケース: 4,267,175,000

### After

- v16: sort時に0を除外(提出: 4,824,000,000, 評価: 3,850,750,000, cost/M: 12.22)
- v18: M=2の時はベイズ(提出: 4,695,698,426, 評価: 3,693,770,790, cost/M: 10.65)(270=>101)
- v19: v18で確率密度関数を使っていたのを累積分布関数に変更。終了しない場合はv16を使用(提出: , 評価: 3,787,845,960, cost/M: 11.59)
